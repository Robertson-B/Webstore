<div class="listing-card" style="position:relative;">
    {# full-card clickable overlay; keep interactive controls above it by raising their z-index #}
    {% set _detail_url = url_for('product_detail', product_id=p['id']) %}
    <a href="{{ _detail_url }}" class="card-overlay" aria-label="View {{ p['title'] }}" style="position:absolute; inset:0; z-index:1; text-decoration:none;">&nbsp;</a>
    <h5>
        {{ p['title'] }}
        {% if p['stock'] is not none %}
            {% set s = p['stock']|int %}
            {% if s <= 0 %}
                <span class="badge bg-danger ms-2">Out of stock</span>
            {% elif s == 1 %}
                <span class="badge bg-warning text-white ms-2">1 left</span>
            {% elif s == 2 %}
                <span class="badge bg-warning text-white ms-2">2 left</span>
            {% elif s == 3 %}
                <span class="badge bg-warning text-white ms-2">3 left</span>
            {% elif s < 5 %}
                <span class="badge bg-warning text-white ms-2">{{ s }} left</span>
            {% endif %}
        {% endif %}
    </h5>
    <p class="price">${{ '%.2f'|format(p['price']) }}</p>
    {# Always render an image container of fixed height so cards align even when an image is missing #}
    <div class="mb-2 text-center image-box" style="height:160px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
        {% if 'image_url' in p.keys() and p['image_url'] %}
            {% set img = p['image_url'] %}
            {% if img.startswith('http://') or img.startswith('https://') or img.startswith('/') %}
                <img src="{{ img }}" alt="{{ p['title'] }}" style="max-height:100%; width:auto; object-fit:contain; background:#fff; border:1px solid #eee; padding:6px; display:block;">
            {% else %}
                <img src="{{ url_for('static', filename='img/' ~ img) }}" alt="{{ p['title'] }}" style="max-height:100%; width:auto; object-fit:contain; background:#fff; border:1px solid #eee; padding:6px; display:block;">
            {% endif %}
        {% else %}
            <div style="width:100%; height:100%; background:#fff; border:1px solid #eee; display:flex; align-items:center; justify-content:center; color:#999; font-size:0.95rem;">No image</div>
        {% endif %}
    </div>

    <div class="seller-info">
        <a href="{{ url_for('seller_profile', seller_id=p['seller_id']) }}" class="text-decoration-none" style="position:relative; z-index:3;">
            <span class="seller-name">{{ p['business_name'] or p['seller_username'] or 'Seller' }}</span>
            {% if p['rating'] %}
                <span class="rating">â˜… {{ '%.1f'|format(p['rating']) }}</span>
            {% endif %}
        </a>
    </div>

    <div class="d-flex justify-content-between align-items-center">
        <span class="text-muted">Posted {{ (p['created_at'] or '')[:10] }}</span>
        <a href="{{ url_for('product_detail', product_id=p['id']) }}" class="btn btn-sm btn-outline-primary" style="position:relative; z-index:4;">View Details</a>
    </div>
</div>
