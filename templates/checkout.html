<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Checkout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* simple suggestion box styling */
    .addr-suggestions { border: 1px solid #ddd; background: #fff; position: absolute; z-index: 1000; max-height: 200px; overflow:auto; width:100%; }
    .addr-suggestions button { width:100%; text-align:left; padding:8px 12px; border:0; background:transparent; }
    .addr-suggestions button:hover { background:#f1f1f1; }
    .addr-wrap { position:relative; }
  </style>
</head>
<body class="p-4">
  {% include 'navbar.html' %}

  <div class="container">
    <h1>Checkout</h1>
    <h4>Order summary</h4>
    <ul>
      {% for it in items %}
        <li>{{ it.quantity }} × {{ it.product['title'] }} — ${{ '%.2f'|format(it.line_total) }}</li>
      {% endfor %}
    </ul>
    <p><strong>Total: ${{ '%.2f'|format(total_amount) }}</strong></p>

    <form method="post" id="checkout-form">
      <div class="mb-3">
        <label class="form-label">Full name</label>
        <input class="form-control" name="name" value="{{ pre_name }}" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input class="form-control" name="email" type="email" value="{{ pre_email }}" required>
      </div>

      <div class="mb-3 addr-wrap">
        <label class="form-label">Shipping address</label>
        <input class="form-control" name="address" id="address-input" autocomplete="street-address" required>
        <div id="addr-suggestions" class="addr-suggestions" style="display:none;"></div>
        <div class="form-text">Suggestions come from your previously used addresses. You can still type a new address.</div>
      </div>

      <button class="btn btn-success">Place order</button>
    </form>
  </div>

<script>
  // debounce helper
  function debounce(fn, delay){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), delay); };}

  const addrInput = document.getElementById('address-input');
  const suggBox = document.getElementById('addr-suggestions');

  async function fetchSuggestions(q){
    if(!q) { suggBox.style.display='none'; suggBox.innerHTML=''; return; }
    const resp = await fetch('/addresses?query=' + encodeURIComponent(q));
    if(!resp.ok) return;
    const list = await resp.json();
    if(!list || list.length === 0){ suggBox.style.display='none'; suggBox.innerHTML=''; return; }
    suggBox.innerHTML = '';
    for(const item of list){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = (item.label ? (item.label + ' — ') : '') + item.address;
      btn.onclick = ()=> {
        addrInput.value = item.address;
        suggBox.style.display='none';
      };
      suggBox.appendChild(btn);
    }
    suggBox.style.display = 'block';
  }

  const debouncedFetch = debounce((e)=> fetchSuggestions(e.target.value.trim()), 250);

  addrInput.addEventListener('input', debouncedFetch);
  // hide suggestions when clicking outside
  document.addEventListener('click', (e)=>{ if(!e.target.closest('.addr-wrap')){ suggBox.style.display='none'; }});

  // prefill address field if any (server could inject a default) - left as is.
</script>
</body>
</html>