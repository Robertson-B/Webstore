<!doctype html>
<html lang="en">
<head>
  {% include 'head_includes.html' %}
  <meta charset="utf-8">
  <title>{{ product['title'] }} - Secret Bay</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .product-image { max-height: 420px; object-fit: contain; width:100%; background:#fff; border:1px solid #eee; padding:8px; }
    .company-statement { background:#fbfbfb; border-left:4px solid #00a87e; padding:12px; margin-top:12px; }
    .stock-badge.low { background:#ffc107; color:#000; }
    .stock-badge.out { background:#dc3545; color:#fff; }
  </style>
</head>
<body class="p-0">
  {% include 'navbar.html' %}

  <div class="container my-4">
    <a href="{{ url_for('products') }}">&laquo; Back to listings</a>

    <div class="row mt-3 g-4">
      <div class="col-md-5">
        {# use mapping test because sqlite3.Row has no .get() #}
  {% if 'image_url' in product.keys() and product['image_url'] %}
          {% set img = product['image_url'] %}
          {% if img.startswith('http://') or img.startswith('https://') or img.startswith('/') %}
            <img src="{{ img }}" class="product-image" alt="{{ product['title'] }}">
          {% else %}
            <img src="{{ url_for('static', filename='img/' ~ img) }}" class="product-image" alt="{{ product['title'] }}">
          {% endif %}
        {% else %}
          <img src="https://via.placeholder.com/600x420?text=No+Image" class="product-image" alt="No image">
        {% endif %}
      </div>

      <div class="col-md-7">
        <h2 class="mb-1">{{ product['title'] }}</h2>
        <div class="mb-2 text-muted">
          <a href="{{ url_for('seller_profile', seller_id=product['seller_id']) }}" class="text-decoration-none">
            {{ product['business_name'] or 'Seller' }}
          </a>
          {% if product['rating'] %}
            <span class="ms-2 text-warning">★ {{ '%.1f'|format(product['rating']) }}</span>
          {% endif %}
          {% if product['category_name'] %}
            <span class="ms-3 text-primary">Category: {{ product['category_name'] }}</span>
          {% endif %}
        </div>

        <p class="lead text-success h4">${{ '%.2f'|format(product['price']) }}</p>

        {% if product['stock'] is not none %}
          {% if product['stock'] <= 0 %}
            <span class="badge stock-badge out">Out of stock</span>
          {% elif product['stock'] < 5 %}
            <span class="badge stock-badge low">{{ product['stock'] }} left</span>
          {% else %}
            <span class="text-muted">In stock</span>
          {% endif %}
        {% endif %}

        <div class="mt-3">
          <form action="{{ url_for('cart_add') }}" method="post" onsubmit="addToCartAjax(event);">
            <input type="hidden" name="product_id" value="{{ product['id'] }}">
            <input type="hidden" name="next" value="{{ request.path }}">
            <div class="d-flex align-items-center" style="gap:0.5rem;">
              <label class="form-label mb-0 me-2">Qty</label>
              <input type="number" name="quantity" value="1" min="1" class="form-control" style="width:100px; height:38px;">
              <button class="btn btn-primary ms-2" type="submit">Add to cart</button>
              <a href="{{ url_for('cart_view') }}" class="btn btn-outline-secondary ms-2">View cart</a>
            </div>
          </form>
        </div>

        {% if product['description'] %}
          <hr>
          <h5>Description</h5>
          <p>{{ product['description'] }}</p>
        {% endif %}
        {% if product['seller_description'] %}
          <div class="company-statement">
            <strong>About {{ product['business_name'] or 'the seller' }}</strong>
            <p class="mb-0">{{ product['seller_description'] }}</p>
          </div>
        {% endif %}

        <!-- Reviews -->
        <hr>
        <h5>Reviews</h5>
        {% if reviews and reviews|length > 0 %}
          <div class="mb-3">
            {% for r in reviews %}
              <div class="border rounded p-2 mb-2">
                <div class="d-flex justify-content-between">
                  <strong>{{ r['title'] or 'Review' }}</strong>
                  <span class="text-warning">★ {{ r['rating'] }}</span>
                </div>
                <div class="text-muted small">by {{ r['author'] or 'Guest' }} on {{ (r['created_at'] or '')[:10] }}</div>
                {% if r['body'] %}
                  <p class="mb-0 mt-2">{{ r['body'] }}</p>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p>No reviews yet.</p>
        {% endif %}

        {% if session.get('user_id') %}
          <div class="card mt-3 mb-4">
            <div class="card-body">
              <h6>Write a review</h6>
              <form method="post" action="{{ url_for('submit_review', product_id=product['id']) }}">
                <div class="mb-2">
                  <label class="form-label">Rating</label>
                  <select name="rating" class="form-select" required>
                    <option value="5">5 - Excellent</option>
                    <option value="4">4 - Very good</option>
                    <option value="3">3 - Good</option>
                    <option value="2">2 - Fair</option>
                    <option value="1">1 - Poor</option>
                  </select>
                </div>
                <div class="mb-2">
                  <input type="text" name="title" class="form-control" placeholder="Summary (optional, max 100 chars)">
                </div>
                <div class="mb-2">
                  <textarea name="body" class="form-control" rows="4" placeholder="Write your review (optional, max 1000 chars)"></textarea>
                </div>
                <button class="btn btn-primary">Submit review</button>
              </form>
            </div>
          </div>
        {% else %}
          <p><a href="{{ url_for('login', next=request.path) }}">Log in</a> to write a review.</p>
        {% endif %}

        <div class="mt-3">
          <small class="text-muted">Product ID: {{ product['id'] }}</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Added-to-cart modal (same as before) -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cartModalLabel">Added to cart</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">Item added. Continue shopping or go to your cart to checkout.</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue shopping</button>
          <a href="{{ url_for('cart_view') }}" class="btn btn-primary">Go to cart</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function addToCartAjax(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const resp = await fetch(form.action, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      });
      if (!resp.ok) { form.submit(); return; }
      const data = await resp.json();
      const badge = document.getElementById('cart-count');
      if (badge) badge.textContent = data.total_items || 0;

      // If server reports failure, show an alert and don't show the modal
      if (!data.ok) {
        alert(data.error || 'Could not add item to cart.');
        return;
      }

      // If server added fewer items than requested, inform the user and do not show the modal
      const requested = parseInt(form.querySelector('input[name="quantity"]').value || '1', 10);
      if (typeof data.added !== 'undefined' && data.added < requested) {
        alert(data.message || `Added ${data.added} of ${requested} due to limited stock.`);
        return;
      }

      // All good: show the added-to-cart modal
      const modal = new bootstrap.Modal(document.getElementById('cartModal'));
      modal.show();
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetch('{{ url_for("cart_summary") }}').then(r => r.json()).then(d => {
        const badge = document.getElementById('cart-count');
        if (badge) badge.textContent = d.total_items || 0;
      }).catch(()=>{});
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  {% include 'footer.html' %}
</body>
</html>