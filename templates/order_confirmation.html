<!doctype html>
<html lang="en">
<head>
  {% include 'head_includes.html' %}
  <meta charset="utf-8">
  <title>Order #{{ order['id'] }}</title>
</head>
<body class="p-4">
  {% include 'navbar.html' %}

  <div class="container">
    <h1>Thank you — order received</h1>
    <p>Order #<strong>{{ order['id'] }}</strong> placed on {{ order['created_at'] }}</p>
    <h4>Shipping</h4>
    <p>{{ order['buyer_name'] }} &mdash; {{ order['buyer_email'] }}</p>
    <p>{{ order['shipping_address'] }}</p>

    <h4 class="mt-4">Items</h4>
    <table class="table">
      <thead><tr><th>Product</th><th>Qty</th><th>Unit</th><th>Line</th></tr></thead>
      <tbody>
        {% for it in items %}
          <tr>
            <td>{{ it['title'] }}</td>
            <td>{{ it['quantity'] }}</td>
            <td>${{ '%.2f'|format(it['unit_price']) }}</td>
            <td>${{ '%.2f'|format(it['unit_price'] * it['quantity']) }}</td>
          </tr>
        {% endfor %}
        <tr>
          <td colspan="3" class="text-end">Subtotal</td>
          <td>${{ '%.2f'|format(subtotal) }}</td>
        </tr>
        <tr>
          <td colspan="3" class="text-end">Shipping</td>
          <td>${{ '%.2f'|format(shipping) }}</td>
        </tr>
        <tr class="fw-bold">
          <td colspan="3" class="text-end">Total</td>
          <td>${{ '%.2f'|format(total) }}</td>
        </tr>
      </tbody>
    </table>

    <a href="{{ url_for('products') }}" class="btn btn-primary">Continue shopping</a>
    <a href="{{ url_for('cart_view') }}" class="btn btn-outline-secondary">View cart</a>
  </div>
      <script>
        // Track purchases for local achievements (adds to localStorage counter)
        (function(){
          try{
            // Build an array of quantities from server-rendered items
            const qtys = [
              {% for it in items %}
                {{ it['quantity'] }}{% if not loop.last %},{% endif %}
              {% endfor %}
            ];
            const sum = qtys.reduce((a,b)=>a+(parseInt(b)||0),0);
            const key = 'easter.purchased_count';
            let prev = 0;
            try{ prev = parseInt(localStorage.getItem(key)||'0') || 0; }catch(e){ prev = 0; }
            const updated = prev + sum;
            try{ localStorage.setItem(key, String(updated)); }catch(e){}

            // When crossing 100 total purchased items, unlock the achievement (if available)
            try{
              if (updated >= 100) {
                if (typeof unlock === 'function') {
                  // avoid unlocking multiple times
                  const unlocked = JSON.parse(localStorage.getItem('easter.unlocked')||'[]');
                  if (!unlocked.includes('hundred_shopper')) {
                    unlock('hundred_shopper','Centurion Shopper','<p>You have purchased 100 items — thanks for shopping!</p>');
                  }
                }
              }
            }catch(e){ console.warn('achievement publish failed', e); }
          }catch(e){ /* ignore any template/render errors */ }
        })();
      </script>
      {% include 'footer.html' %}
  </body>
  </html>