<nav class="navbar navbar-expand-lg mb-3 site-navbar" aria-label="Main navigation">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
  <img id="site-logo" src="{{ url_for('static', filename='img/logo.svg') }}" alt="Card Haven logo" height="32" class="me-2 site-logo" style="width:auto;" title="Card Haven">
  <span>Card Haven</span>
    </a>

  <!-- Search placed next to brand so it's always visible and accessible on mobile; hidden on large screens where desktop search is shown -->
  <form class="d-flex ms-2 flex-grow-1 d-lg-none" action="{{ url_for('products') }}" method="get">
      <input name="search" class="form-control form-control-sm" type="search" placeholder="Search listings..." aria-label="Search" value="{{ request.args.get('search','') }}">
      <button class="btn btn-sm btn-primary ms-2" type="submit">Search</button>
    </form>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
  <li class="nav-item"><a class="nav-link" href="/products">Browse</a></li>
        {% if current_user_is_seller %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('seller_dashboard') }}">Seller Dashboard</a></li>
        {% endif %}
        {% if current_user_is_admin %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_index') }}">Admin</a></li>
        {% endif %}
        {# Mobile-only actions as top-level nav items inside the collapsed menu #}
        <li class="nav-item d-lg-none">
          <a class="nav-link" href="#" onclick="toggleTheme(); return false;">Toggle theme</a>
        </li>
        <li class="nav-item d-lg-none">
          <a class="nav-link" href="{{ url_for('cart_view') }}" data-collapse-nav="1">Cart <span id="cart-count-mobile" class="badge bg-primary ms-2">0</span></a>
        </li>
        {% if session.get('user_id') %}
          <li class="nav-item d-lg-none"><a class="nav-link" href="{{ url_for('logout') }}" data-collapse-nav="1">Log out ({{ session.get('username') }})</a></li>
        {% else %}
          <li class="nav-item d-lg-none"><a class="nav-link" href="{{ url_for('login') }}" data-collapse-nav="1">Login</a></li>
          <li class="nav-item d-lg-none"><a class="nav-link" href="{{ url_for('register') }}" data-collapse-nav="1">Register</a></li>
        {% endif %}
      </ul>

  <div class="d-none d-lg-flex align-items-center gap-2 navbar-right">
        <!-- Theme toggle -->
        <button id="theme-toggle" class="btn btn-sm btn-outline-secondary me-1" title="Toggle theme" onclick="toggleTheme()">ðŸŒ—</button>
        <!-- Desktop search (visible on large screens) -->
        <form class="d-none d-lg-flex align-items-center me-2" action="{{ url_for('products') }}" method="get">
          <input name="search" class="form-control form-control-sm me-2" type="search" placeholder="Search listings..." aria-label="Search" value="{{ request.args.get('search','') }}">
          <button class="btn btn-sm btn-primary" type="submit">Search</button>
        </form>

        <a href="{{ url_for('cart_view') }}" class="btn btn-outline-secondary position-relative">
          Cart <span id="cart-count" class="badge bg-primary ms-2">0</span>
        </a>

        {% if session.get('user_id') %}
          <div class="text-end user-info mt-2 mt-lg-0">
            <div>Logged in as <strong>{{ session.get('username') }}</strong></div>
            <a href="{{ url_for('logout') }}" class="small">Log out</a>
          </div>
        {% else %}
          <div class="auth-buttons d-flex gap-1 mt-2 mt-lg-0">
            <a href="{{ url_for('login') }}" class="btn btn-sm btn-outline-primary">Login</a>
            <a href="{{ url_for('register') }}" class="btn btn-sm btn-primary">Register</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</nav>

<script>
  // refresh cart badge on page load
  document.addEventListener('DOMContentLoaded', () => {
    fetch('{{ url_for("cart_summary") }}').then(r => r.json()).then(d => {
      const badge = document.getElementById('cart-count');
      const badgeMobile = document.getElementById('cart-count-mobile');
      if (badge) badge.textContent = d.total_items || 0;
      if (badgeMobile) badgeMobile.textContent = d.total_items || 0;
    }).catch(()=>{});

    // Ensure mobile nav links close the collapsed navbar and then navigate.
    try {
      document.querySelectorAll('[data-collapse-nav="1"]').forEach(el => {
        el.addEventListener('click', function(e){
          // if link is an anchor to same page or '#', allow default
          const href = el.getAttribute('href');
          const collapseEl = document.getElementById('mainNav');
          try {
            if (collapseEl && collapseEl.classList.contains('show')) {
              // use Bootstrap's Collapse API if available
              if (window.bootstrap && window.bootstrap.Collapse) {
                const instance = window.bootstrap.Collapse.getInstance(collapseEl) || new window.bootstrap.Collapse(collapseEl, {toggle:false});
                instance.hide();
              } else {
                collapseEl.classList.remove('show');
              }
            }
          } catch (err) {
            // ignore
          }
          if (href && href !== '#') {
            e.preventDefault();
            // small delay to allow collapse animation to run
            setTimeout(() => { window.location.href = href; }, 200);
          }
        });
      });
    } catch (err) {
      // ignore
    }
  });
</script>

<style>
  /* Small navbar-brand image sizing to keep markup portable across templates */
  .navbar-brand img { height: 32px; width: auto; display: inline-block; vertical-align: middle; }
  /* Ensure navbar uses theme-aware surface color instead of Bootstrap's bg-white */
  .site-navbar { background: var(--surface) !important; }
  .site-navbar .nav-link { color: var(--text) !important; }
  /* Make brand text slightly smaller on mobile and allow the search to shrink */
  .site-navbar .navbar-brand span { font-size: 1.05rem; font-weight: 600; }
  .site-navbar form.d-flex { min-width: 0; }
  .site-navbar .form-control { min-width: 0; }

  /* Toggler: black background with white icon for contrast on all backgrounds */
  .site-navbar .navbar-toggler { background-color: #000 !important; border: none; padding: .3rem .5rem; border-radius: 6px; }
  .site-navbar .navbar-toggler-icon { background-image: url("data:image/svg+xml;charset=utf8,%3Csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath stroke='rgba(255,255,255,1)' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 7h22M4 15h22M4 23h22'/%3E%3C/svg%3E"); }

  @media (max-width: 767.98px) {
    .site-navbar .navbar-brand span { font-size: 0.95rem; }
    /* allow the search to occupy remaining space but not push the toggler off */
    .site-navbar form.d-flex { max-width: 60%; }
  }
</style>

<!-- open a site-content wrapper so footer can push to bottom via flexbox -->
<main class="site-content">